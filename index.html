<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFMC Weekly Training Schedule</title>
    
    <!-- iOS Compatibility & "Add to Home Screen" Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AFMC Schedule">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/022c7a/ffffff?text=AFMC">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .day-view { scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .day-slide { scroll-snap-align: start; flex-shrink: 0; width: 100%; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        
        /* Style for calendar days */
        .holiday { background-color: #facc15; color: #713f12; border-radius: 50%; font-weight: bold; } /* Vibrant Yellow */
        .event-day { background-color: #bfdbfe; border-radius: 50%; }
        .sunday { background-color: #fecaca; color: #991b1b; border-radius: 50%; } /* Light Red */
        .today-calendar { border: 2px solid #2563eb; border-radius: 50%; }

        /* Style for highlighting the current day's header in the main view */
        .current-day-header {
            background-color: #e0f2fe; /* Light cyan */
            color: #0c4a6e; /* Dark cyan */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #bae6fd;
        }

        /* Disable tap highlight on iOS */
        button, select {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">
        <header class="bg-blue-800 text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <div>
                <h1 class="text-xl font-bold">AFMC Training Schedule</h1>
                <p id="current-week-display" class="text-sm opacity-90"></p>
            </div>
            <div class="flex items-center space-x-2">
                 <button id="today-btn" aria-label="Go to today" class="p-2 rounded-full hover:bg-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        <circle cx="12" cy="14" r="1.5" fill="currentColor" />
                    </svg>
                </button>
                <button id="calendar-view-btn" aria-label="Open calendar view" class="p-2 rounded-full hover:bg-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </button>
            </div>
        </header>

        <div id="user-view">
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-4">
                    <select id="department-filter" class="w-full p-2 border rounded-md bg-white"><option value="all">All Departments</option></select>
                    <button id="add-to-calendar-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition">Add to Calendar</button>
                </div>
            </div>
            <div id="day-view-container" class="overflow-x-auto day-view flex"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20"><div class="bg-white rounded-lg shadow-xl p-4 w-11/12 max-w-md"><div id="calendar-header" class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="px-2 py-1">&lt;</button><h3 id="month-year-display" class="text-lg font-semibold"></h3><button id="next-month-btn" class="px-2 py-1">&gt;</button></div><div id="calendar-grid" class="calendar-grid gap-2 text-center"></div><button id="close-calendar-modal" class="w-full mt-4 bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600">Close</button></div></div>
    <div id="roll-no-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><h3 class="text-lg font-semibold mb-4">Enter Your Roll Number</h3><input type="number" id="roll-no-input" class="w-full p-2 border rounded-md text-center mb-4" placeholder="e.g., 42" min="1" max="150"><button id="submit-roll-no-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded">Get My Schedule File</button><button id="close-roll-no-modal" class="w-full mt-4 bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button></div></div>
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><p id="alert-message" class="mb-4"></p><button id="close-alert-modal" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">OK</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const config = {
                departmentColors: { 
                    "Internal Medicine": "border-blue-500", 
                    "Community Medicine": "border-green-500", 
                    "Ophthalmology": "border-purple-500", 
                    "Obs & Gynae": "border-pink-500", 
                    "ENT": "border-yellow-500", 
                    "Forensic Medicine": "border-red-500", 
                    "Orthopaedics": "border-orange-500" 
                },
                defaultDeptColor: "border-gray-500",
                rollNoRanges: {
                    clinic: { A: [1, 38], B: [39, 76], C: [77, 112], D: [113, 150] },
                    general: { A: [1, 50], B: [51, 100], C: [101, 150] }
                }
            };

            // --- DATA SOURCE (JSON String) ---
            const jsonData = `
            [
                { "date": "2025-08-25", "startTime": "08:00", "endTime": "09:00", "department": "Internal Medicine", "topic": "Lecture: Rheumatologic problems-II", "instructor": "Col V Koshy", "location": "NLH Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-25", "startTime": "09:00", "endTime": "10:00", "department": "Community Medicine", "topic": "Basic Statistics and its application", "instructor": "Dr. Seema Pannikar", "location": "Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-25", "startTime": "10:00", "endTime": "13:00", "department": "Ophthalmology", "topic": "Colour vision assessment and pupillary reflexes", "instructor": "CHSC", "location": "Service Eye OPD and OT CHSC", "batch": ["D"], "isClinic": true },
                { "date": "2025-08-25", "startTime": "10:30", "endTime": "13:00", "department": "Obs & Gynae", "topic": "ANC history taking and Obstetric Examination", "instructor": "Maj Sunilkumar", "location": "Civ OPD", "batch": ["C"], "isClinic": true },
                { "date": "2025-08-25", "startTime": "10:30", "endTime": "13:00", "department": "ENT", "topic": "CLINICS: Case Presentation: Ear Part-1", "instructor": "Maj V S Sreejith / Col MS Boparai", "location": "Civil ENT OPD", "batch": ["A"], "isClinic": true },
                { "date": "2025-08-25", "startTime": "11:00", "endTime": "13:00", "department": "Orthopaedics", "topic": "Clinics: History Taking", "instructor": "Surg Lt Cdr AC Tiwary", "location": "CH(SC)", "batch": ["B"], "isClinic": true },
                { "date": "2025-08-25", "startTime": "14:00", "endTime": "15:00", "department": "Internal Medicine", "topic": "Tutorial: Portal Hypertension", "instructor": "Clinical Tutor", "location": "NLH Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-25", "startTime": "15:00", "endTime": "16:00", "department": "Forensic Medicine", "topic": "Non metallic Irritants/animal & plant irritants", "instructor": "Maj Ishita Manral", "location": "LH Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-26", "startTime": "08:00", "endTime": "09:00", "department": "Community Medicine", "topic": "International Health & Recent Advances", "instructor": "Major Nidhi Rana", "location": "Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-26", "startTime": "10:00", "endTime": "13:00", "department": "Ophthalmology", "topic": "Types of cataract surgery, Phacoemulsification", "instructor": "CHSC", "location": "Service Eye OPD,OT CHSC", "batch": ["D"], "isClinic": true },
                { "date": "2025-08-26", "startTime": "10:30", "endTime": "13:00", "department": "Obs & Gynae", "topic": "AUB", "instructor": "Col Sanjay Kumar Sharma", "location": "Civ OPD", "batch": ["C"], "isClinic": true },
                { "date": "2025-08-26", "startTime": "10:30", "endTime": "13:00", "department": "ENT", "topic": "CLINICS: Case Presentation: Ear Part-2", "instructor": "Col Vikas Gupta", "location": "Service ENT OPD", "batch": ["A"], "isClinic": true },
                { "date": "2025-08-26", "startTime": "11:00", "endTime": "13:00", "department": "Orthopaedics", "topic": "Clinics: Closed reduction of fractures", "instructor": "Maj Abhay Singh", "location": "CH(SC)", "batch": ["B"], "isClinic": true },
                { "date": "2025-08-27", "isHoliday": true, "topic": "Holiday" },
                { "date": "2025-08-27", "startTime": "11:00", "endTime": "13:00", "department": "Orthopaedics", "topic": "Clinics: Instruments", "instructor": "Surg Lt Cdr AC Tiwary", "location": "CH(SC)", "batch": ["B"], "isClinic": true },
                { "date": "2025-08-27", "startTime": "14:00", "endTime": "15:00", "department": "Orthopaedics", "topic": "SDL: Fracture distal end of radius", "instructor": "Maj Abhay Singh", "location": "NLH- Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-28", "startTime": "08:00", "endTime": "09:00", "department": "Obs & Gynae", "topic": "Heart Disease in Pregnancy", "instructor": "Lt Col Ankur Shah", "location": "Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-28", "startTime": "10:00", "endTime": "13:00", "department": "Ophthalmology", "topic": "Instruments", "instructor": "CHSC", "location": "Service Eye OPD and OT CHSC", "batch": ["D"], "isClinic": true },
                { "date": "2025-08-28", "startTime": "10:30", "endTime": "13:00", "department": "Obs & Gynae", "topic": "Fibroid Uterus", "instructor": "Col Sirisha Anne", "location": "Civ OPD", "batch": ["C"], "isClinic": true },
                { "date": "2025-08-28", "startTime": "10:30", "endTime": "13:00", "department": "ENT", "topic": "CLINICS: Case Presentation: Nose Part-1", "instructor": "Lt Col Rahul Kurkure", "location": "Service ENT OPD", "batch": ["A"], "isClinic": true },
                { "date": "2025-08-28", "startTime": "11:00", "endTime": "13:00", "department": "Orthopaedics", "topic": "Clinics: Malunion of fracture", "instructor": "Maj Abhay Singh", "location": "CH(SC)", "batch": ["B"], "isClinic": true },
                { "date": "2025-08-28", "startTime": "14:00", "endTime": "15:00", "department": "Obs & Gynae", "topic": "Anti-hypertensives in pregnancy", "instructor": "Col Suneeta Singh", "location": "Charaka Sushruta", "batch": ["A", "B"] },
                { "date": "2025-08-28", "startTime": "14:00", "endTime": "15:00", "department": "Obs & Gynae", "topic": "Uterotonics in PPH", "instructor": "VKD", "location": "Charaka Sushruta", "batch": ["C"] },
                { "date": "2025-08-28", "startTime": "15:00", "endTime": "16:00", "department": "Community Medicine", "topic": "NTEP Tutorial", "instructor": "Colonel Harpreet Singh / JR1", "location": "LH-10", "batch": ["A"] },
                { "date": "2025-08-28", "startTime": "15:00", "endTime": "16:00", "department": "Community Medicine", "topic": "NTEP Tutorial", "instructor": "Lieutenant Colonel Kapil Pabba / JR-1", "location": "LH-11", "batch": ["B"] },
                { "date": "2025-08-28", "startTime": "15:00", "endTime": "16:00", "department": "Community Medicine", "topic": "NTEP Tutorial", "instructor": "Major Nidhi Rana / JR-1", "location": "Manson Hall", "batch": ["C"] },
                { "date": "2025-08-29", "startTime": "08:00", "endTime": "09:00", "department": "Forensic Medicine", "topic": "Deliriants / Spinal / Systemic poisons", "instructor": "Lt Col Anandhakrishnan / Lt Col Thippesh Kumar N", "location": "LH Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-29", "startTime": "09:00", "endTime": "10:00", "department": "Community Medicine", "topic": "AETCOM Module 1.3", "instructor": "Wing Commander Amol Nath", "location": "Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-29", "startTime": "10:00", "endTime": "12:00", "department": "Ophthalmology", "topic": "Ocular anaesthesia", "instructor": "CHSC", "location": "Service Eye OPD and OT CHSC", "batch": ["D"], "isClinic": true },
                { "date": "2025-08-29", "startTime": "10:30", "endTime": "13:00", "department": "Obs & Gynae", "topic": "Anemia in Pregnancy", "instructor": "Dr Meenakshi K Bharadwaj", "location": "Civ Maty Ward", "batch": ["C"], "isClinic": true },
                { "date": "2025-08-29", "startTime": "10:30", "endTime": "13:00", "department": "ENT", "topic": "CLINICS: Case Presentation: Nose Part-2", "instructor": "Maj V S Sreejith", "location": "Civil ENT OPD", "batch": ["A"], "isClinic": true },
                { "date": "2025-08-29", "startTime": "11:00", "endTime": "13:00", "department": "Orthopaedics", "topic": "Clinics: X-rays", "instructor": "Sqn Ldr R Anand", "location": "CH(SC)", "batch": ["B"], "isClinic": true },
                { "date": "2025-08-30", "startTime": "08:00", "endTime": "09:00", "department": "Orthopaedics", "topic": "Theory: Pelvic Injuries", "instructor": "Lt Col DK Deepak", "location": "NLH- Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-30", "startTime": "09:00", "endTime": "10:00", "department": "Ophthalmology", "topic": "Cataract", "instructor": "Wg Cdr Vinay Kumar Sharma", "location": "NLH Sushruta", "batch": ["ALL"] },
                { "date": "2025-08-30", "startTime": "10:00", "endTime": "13:00", "department": "Ophthalmology", "topic": "Ocular movements and abnormalities", "instructor": "Wg Cdr Vinay Kumar Sharma / CHSC / Wg Cdr Rajat Chaudhary", "location": "Service Eye OPD, GJB", "batch": ["D"], "isClinic": true },
                { "date": "2025-08-30", "startTime": "10:30", "endTime": "13:00", "department": "Obs & Gynae", "topic": "Fetal growth restriction", "instructor": "Col Madhusudan Dey", "location": "Civ OPD", "batch": ["A"], "isClinic": true },
                { "date": "2025-08-30", "startTime": "10:30", "endTime": "13:00", "department": "ENT", "topic": "CLINICS: Preop Clinics", "instructor": "Lt Col Meenakshi Rajput", "location": "Civil ENT OPD", "batch": ["A"], "isClinic": true },
                { "date": "2025-08-30", "startTime": "11:00", "endTime": "13:00", "department": "Orthopaedics", "topic": "Clinics: Knee and Hip Examination", "instructor": "Sqn Ldr R Anand", "location": "CH(SC)", "batch": ["B"], "isClinic": true },
                { "date": "2025-08-30", "startTime": "14:00", "endTime": "15:00", "department": "Community Medicine", "topic": "NACP Tutorial", "instructor": "Lieutenant Colonel Kapil Pabba / JR-1", "location": "LH-10", "batch": ["A"] },
                { "date": "2025-08-30", "startTime": "14:00", "endTime": "15:00", "department": "Community Medicine", "topic": "NACP Tutorial", "instructor": "Wing Commander Amol Nath / JR1", "location": "LH-11", "batch": ["B"] },
                { "date": "2025-08-30", "startTime": "14:00", "endTime": "15:00", "department": "Community Medicine", "topic": "NACP Tutorial", "instructor": "Major Nidhi Rana / JR-1", "location": "Manson Hall", "batch": ["C"] },
                { "date": "2025-08-31", "isHoliday": true, "topic": "Holiday" }
            ]
            `;

            // --- GLOBAL STATE ---
            let scheduleData = [];
            let allWeeks = [];
            let currentVisibleWeekStart = null;
            let calendarDate = new Date();
            let intersectionObserver;

            // --- DOM ELEMENTS CACHE---
            const elements = {
                dayViewContainer: document.getElementById('day-view-container'),
                deptFilter: document.getElementById('department-filter'),
                calendarModal: document.getElementById('calendar-modal'),
                rollNoModal: document.getElementById('roll-no-modal'),
                alertModal: document.getElementById('alert-modal'),
                alertMessage: document.getElementById('alert-message'),
                weekDisplay: document.getElementById('current-week-display'),
                rollNoInput: document.getElementById('roll-no-input'),
                calendarGrid: document.getElementById('calendar-grid'),
                monthYearDisplay: document.getElementById('month-year-display'),
            };

            // --- UTILITY FUNCTIONS ---
            const formatDate = (date) => {
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            const getStartOfWeek = (date) => {
                const d = new Date(date);
                const day = d.getUTCDay();
                const diff = d.getUTCDate() - day + (day === 0 ? -6 : 1);
                d.setUTCDate(diff);
                d.setUTCHours(0, 0, 0, 0);
                return d;
            };

            const customAlert = (message) => {
                elements.alertMessage.textContent = message;
                elements.alertModal.classList.remove('hidden');
            };

            // --- DATA PROCESSING ---
            const processAndGroupData = () => {
                const uniqueDates = [...new Set(scheduleData.map(e => e.date))].sort();
                if (uniqueDates.length === 0) { allWeeks = []; return; }

                const weekStarts = [...new Set(uniqueDates.map(d => formatDate(getStartOfWeek(new Date(d + 'T00:00:00Z')))))].sort();
                
                allWeeks = weekStarts.map(startDateStr => {
                    const startDate = new Date(startDateStr + 'T00:00:00Z');
                    const endDate = new Date(startDate);
                    endDate.setUTCDate(endDate.getUTCDate() + 6);
                    const days = Array.from({ length: 7 }, (_, i) => {
                        const dayDate = new Date(startDate);
                        dayDate.setUTCDate(startDate.getUTCDate() + i);
                        return dayDate;
                    });
                    return { startDate, endDate, days };
                });
            };

            // --- HTML TEMPLATE CREATORS ---
            const createEventCardHTML = (event) => {
                const deptColor = config.departmentColors[event.department] || config.defaultDeptColor;
                const batchDisplay = event.batch.includes('ALL') ? 'All Batches' : `Batch ${event.batch.join(', ')}`;
                const batchColor = event.batch.includes('ALL') ? 'bg-gray-500' : 'bg-purple-600';

                return `
                    <div class="bg-white border-l-4 ${deptColor} rounded-r-lg p-4 mb-3 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold text-lg">${event.topic}</p><p class="text-sm text-gray-600">${event.department}</p></div>
                            <div class="text-right flex-shrink-0 ml-4"><p class="font-semibold text-blue-600">${event.startTime} - ${event.endTime}</p><p class="text-sm text-gray-500">${event.location}</p></div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center text-sm">
                            <p class="text-gray-700"><strong>Instructor:</strong> ${event.instructor}</p>
                            <p class="font-medium text-white text-xs px-2 py-1 rounded-full ${batchColor}">${batchDisplay}</p>
                        </div>
                    </div>`;
            };
            
            const createDaySlide = (day, weekStartDate) => {
                const dayString = formatDate(day);
                const selectedDept = elements.deptFilter.value;
                const events = scheduleData
                    .filter(event => event.date === dayString && (selectedDept === 'all' || event.department === selectedDept))
                    .sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));

                const daySlide = document.createElement('div');
                daySlide.className = 'day-slide p-4';
                daySlide.dataset.date = dayString;
                daySlide.dataset.weekStart = formatDate(weekStartDate);

                const dayHeader = document.createElement('h2');
                dayHeader.className = 'text-2xl font-bold mb-4 text-blue-700';
                dayHeader.textContent = day.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' });
                if (dayString === formatDate(new Date())) {
                    dayHeader.classList.add('current-day-header');
                }
                daySlide.appendChild(dayHeader);

                const hasHoliday = events.some(e => e.isHoliday);
                const classEvents = events.filter(e => !e.isHoliday);
                const isSunday = day.getUTCDay() === 0;
                
                let contentHTML = '';
                if (classEvents.length === 0) {
                    if (hasHoliday || isSunday) {
                        contentHTML = `<div class="text-center text-green-600 py-20"><p class="text-4xl font-bold">Holiday</p></div>`;
                    } else {
                        contentHTML = `<div class="text-center text-gray-500 py-10"><p class="font-semibold">No sessions scheduled for today.</p></div>`;
                    }
                } else {
                    contentHTML = classEvents.map(createEventCardHTML).join('');
                }
                daySlide.innerHTML += contentHTML;
                return daySlide;
            };

            // --- RENDER FUNCTIONS ---
            const renderFullSchedule = () => {
                if (intersectionObserver) intersectionObserver.disconnect();
                
                const fragment = document.createDocumentFragment();
                allWeeks.forEach(week => {
                    week.days.forEach(day => {
                        fragment.appendChild(createDaySlide(day, week.startDate));
                    });
                });
                elements.dayViewContainer.replaceChildren(fragment); // More efficient than innerHTML = ''
                
                if (allWeeks.length === 0) {
                    elements.dayViewContainer.innerHTML = `<div class="p-4 text-center text-gray-500 w-full">No schedule data available.</div>`;
                    elements.weekDisplay.textContent = "No Schedule";
                    return;
                }

                setupIntersectionObserver();
            };

            const renderCalendar = () => {
                elements.monthYearDisplay.textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
                const todayString = formatDate(new Date());

                const month = calendarDate.getUTCMonth();
                const year = calendarDate.getUTCFullYear();
                const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay();
                const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
                
                let cellsHTML = ['S','M','T','W','T','F','S'].map(d => `<div class="font-bold text-gray-600">${d}</div>`).join('');
                cellsHTML += '<div></div>'.repeat(firstDayOfMonth);

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDay = new Date(Date.UTC(year, month, day));
                    const dateStr = formatDate(currentDay);
                    const dayEvents = scheduleData.filter(e => e.date === dateStr);
                    let classes = 'p-2 cursor-pointer hover:bg-gray-200 rounded-full';
                    
                    if (dateStr === todayString) classes += ' today-calendar';
                    if (currentDay.getUTCDay() === 0) classes += ' sunday';
                    if (dayEvents.some(e => e.isHoliday)) {
                        classes = classes.replace('sunday', '') + ' holiday'; 
                    } else if (dayEvents.some(e => !e.isHoliday)) {
                        classes += ' event-day';
                    }
                    cellsHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
                }
                elements.calendarGrid.innerHTML = cellsHTML;
            };

            // --- UI & NAVIGATION ---
            const scrollToInitialView = () => {
                const todayString = formatDate(new Date());
                const targetSlide = document.querySelector(`.day-slide[data-date="${todayString}"]`) || 
                                    (allWeeks.length > 0 ? document.querySelector(`.day-slide[data-date="${formatDate(allWeeks[allWeeks.length - 1].days[0])}"]`) : null);
                if (targetSlide) {
                    targetSlide.scrollIntoView({ behavior: 'instant', block: 'nearest', inline: 'start' });
                }
            };

            const setupIntersectionObserver = () => {
                const slides = document.querySelectorAll('.day-slide');
                if (slides.length === 0) return;
                intersectionObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const weekStart = entry.target.dataset.weekStart;
                            if (weekStart !== currentVisibleWeekStart) {
                                currentVisibleWeekStart = weekStart;
                                updateHeader(weekStart);
                            }
                        }
                    });
                }, { threshold: 0.5, root: elements.dayViewContainer });
                slides.forEach(slide => intersectionObserver.observe(slide));
            };

            const updateHeader = (weekStartDateStr) => {
                const week = allWeeks.find(w => formatDate(w.startDate) === weekStartDateStr);
                if (week) {
                    const start = week.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                    const end = week.endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
                    elements.weekDisplay.textContent = `${start} - ${end}`;
                    calendarDate = new Date(week.startDate);
                }
            };
            
            const populateFilters = () => {
                const departments = [...new Set(scheduleData.map(item => item.department).filter(Boolean))].sort();
                const optionsHTML = departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
                elements.deptFilter.innerHTML = `<option value="all">All Departments</option>${optionsHTML}`;
            };
            
            // --- BATCH & ICS LOGIC ---
            const getBatchForRollNo = (rollNo) => {
                const findBatch = (ranges) => {
                    for (const batch in ranges) {
                        if (rollNo >= ranges[batch][0] && rollNo <= ranges[batch][1]) return batch;
                    }
                    return null;
                };
                return {
                    clinic: findBatch(config.rollNoRanges.clinic),
                    general: findBatch(config.rollNoRanges.general),
                };
            };

            const generateICS = (events) => {
                const toICSDate = (date, time) => `${date.replace(/-/g, '')}T${time.replace(/:/g, '')}00`;
                let icsString = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//AFMCScheduleApp//EN'];
                events.forEach(event => {
                    icsString.push(
                        'BEGIN:VEVENT',
                        `UID:${event.date}-${event.startTime}@afmc.schedule`,
                        `DTSTAMP:${new Date().toISOString().replace(/[-:.]/g, '')}Z`,
                        `DTSTART;TZID=Asia/Kolkata:${toICSDate(event.date, event.startTime)}`,
                        `DTEND;TZID=Asia/Kolkata:${toICSDate(event.date, event.endTime)}`,
                        `SUMMARY:${event.topic}`,
                        `LOCATION:${event.location}`,
                        `DESCRIPTION:Instructor: ${event.instructor}\\nDepartment: ${event.department}`,
                        'END:VEVENT'
                    );
                });
                icsString.push('END:VCALENDAR');
                return icsString.join('\r\n');
            };

            const downloadICS = (icsData) => {
                const blob = new Blob([icsData], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'MySchedule.ics';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- EVENT HANDLERS ---
            const handleCalendarExport = () => {
                const rollNo = parseInt(elements.rollNoInput.value);
                if (!rollNo || rollNo < 1 || rollNo > 150) {
                    customAlert("Please enter a valid Roll Number (1-150).");
                    return;
                }

                const batches = getBatchForRollNo(rollNo);
                const currentWeek = allWeeks.find(w => formatDate(w.startDate) === currentVisibleWeekStart);
                if (!currentWeek) {
                    customAlert("Could not determine the current week to add to calendar.");
                    return;
                }

                const eventsToAdd = scheduleData.filter(event => {
                    const eventDate = new Date(event.date + 'T00:00:00Z');
                    if (eventDate < currentWeek.startDate || eventDate > currentWeek.endDate || event.isHoliday || !event.batch) return false;
                    if (event.batch.includes('ALL')) return true;
                    return event.isClinic ? event.batch.includes(batches.clinic) : event.batch.includes(batches.general);
                });
                
                if (eventsToAdd.length > 0) {
                    downloadICS(generateICS(eventsToAdd));
                } else {
                    customAlert(`No specific schedule found for Roll No. ${rollNo} in the current week.`);
                }
                elements.rollNoModal.classList.add('hidden');
                elements.rollNoInput.value = '';
            };
            
            const setupEventListeners = () => {
                elements.deptFilter.addEventListener('change', renderFullSchedule);
                document.getElementById('add-to-calendar-btn').addEventListener('click', () => elements.rollNoModal.classList.remove('hidden'));
                document.getElementById('close-roll-no-modal').addEventListener('click', () => elements.rollNoModal.classList.add('hidden'));
                document.getElementById('close-alert-modal').addEventListener('click', () => elements.alertModal.classList.add('hidden'));
                document.getElementById('calendar-view-btn').addEventListener('click', () => { renderCalendar(); elements.calendarModal.classList.remove('hidden'); });
                document.getElementById('close-calendar-modal').addEventListener('click', () => elements.calendarModal.classList.add('hidden'));
                document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() - 1); renderCalendar(); });
                document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() + 1); renderCalendar(); });
                document.getElementById('today-btn').addEventListener('click', () => {
                    const todaySlide = document.querySelector(`.day-slide[data-date="${formatDate(new Date())}"]`);
                    if (todaySlide) {
                       todaySlide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                    } else {
                       customAlert("Today's date is not found in the current schedule data.");
                    }
                });
                elements.calendarGrid.addEventListener('click', (e) => {
                    const dayCell = e.target.closest('[data-date]');
                    if (dayCell) {
                        const targetSlide = document.querySelector(`.day-slide[data-date="${dayCell.dataset.date}"]`);
                        if (targetSlide) {
                            targetSlide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                        } else {
                            customAlert("This date is not available in the schedule view.");
                        }
                        elements.calendarModal.classList.add('hidden');
                    }
                });
                document.getElementById('submit-roll-no-btn').addEventListener('click', handleCalendarExport);
            };

            // --- INITIALIZATION ---
            const main = () => {
                try {
                    scheduleData = JSON.parse(jsonData);
                } catch (error) {
                    console.error("Error parsing schedule data:", error);
                    elements.dayViewContainer.innerHTML = `<div class="p-4 text-center text-red-500 w-full"><h3 class="font-bold text-lg">Error in Schedule Data</h3><p>The provided schedule data could not be read.</p></div>`;
                    elements.weekDisplay.textContent = "Error";
                    return;
                }
                processAndGroupData();
                populateFilters();
                renderFullSchedule();
                scrollToInitialView();
                setupEventListeners();
            };

            main();
        });
    </script>
</body>
</html>
