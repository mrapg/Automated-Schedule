<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFMC Weekly Training Schedule</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AFMC Schedule">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/022c7a/ffffff?text=AFMC">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .day-view { scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .day-slide { scroll-snap-align: start; flex-shrink: 0; width: 100%; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .holiday { background-color: #facc15; color: #713f12; border-radius: 50%; font-weight: bold; }
        .event-day { background-color: #bfdbfe; border-radius: 50%; }
        .sunday { color: #991b1b; }
        .today-highlight { background-color: #dbeafe; } /* Light blue for today */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">
        <header class="bg-blue-800 text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <div>
                <h1 class="text-xl font-bold">AFMC Training Schedule</h1>
                <p id="current-week-display" class="text-sm opacity-90"></p>
            </div>
            <div class="flex items-center space-x-2">
                 <button id="today-btn" class="p-2 rounded-full hover:bg-blue-700" title="Go to Today">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 002-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>
                </button>
                <button id="calendar-view-btn" class="p-2 rounded-full hover:bg-blue-700" title="Calendar View">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 002-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </button>
            </div>
        </header>

        <div id="user-view">
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-4">
                    <select id="department-filter" class="w-full p-2 border rounded-md bg-white"><option value="all">All Departments</option></select>
                    <button id="add-to-calendar-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition">Add to Calendar</button>
                </div>
            </div>
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center p-10">
                <p class="text-gray-500 font-semibold animate-pulse">Loading Schedule...</p>
            </div>
            <div id="day-view-container" class="overflow-x-auto day-view flex"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20"><div class="bg-white rounded-lg shadow-xl p-4 w-11/12 max-w-md"><div id="calendar-header" class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="px-2 py-1">&lt;</button><h3 id="month-year-display" class="text-lg font-semibold"></h3><button id="next-month-btn" class="px-2 py-1">&gt;</button></div><div id="calendar-grid" class="calendar-grid gap-2 text-center"></div><button id="close-calendar-modal" class="w-full mt-4 bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600">Close</button></div></div>
    <div id="roll-no-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><h3 class="text-lg font-semibold mb-4">Enter Your Roll Number</h3><input type="number" id="roll-no-input" class="w-full p-2 border rounded-md text-center mb-4" placeholder="e.g., 42" min="1" max="150"><button id="submit-roll-no-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded">Get My Schedule File</button><button id="close-roll-no-modal" class="w-full mt-4 bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button></div></div>
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><p id="alert-message" class="mb-4"></p><button id="close-alert-modal" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">OK</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import * as utils from './utils.js'; // Assuming utils.js is in the same directory

        // --- FIREBASE CONFIG (Placeholder) ---
        const firebaseConfig = {
          apiKey: "AIzaSyC6jkkGL8OA47muh3Bwer9qFRMUejmnso8",
          authDomain: "training-schedule-7c862.firebaseapp.com",
          projectId: "training-schedule-7c862",
          storageBucket: "training-schedule-7c862.firebasestorage.app",
          messagingSenderId: "395637809585",
          appId: "1:395637809585:web:9a5eea7f80741083f49d90",
          measurementId: "G-S9EXHXY981"
        };
        const appId = "training-schedule-7c862";

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));

        // --- GLOBAL STATE & DOM ELEMENTS ---
        let scheduleData = [];
        let allWeeks = [];
        let currentVisibleWeekStart = null;
        let calendarDate = new Date();
        let intersectionObserver;

        const dayViewContainer = document.getElementById('day-view-container');
        const deptFilter = document.getElementById('department-filter');
        const weekDisplay = document.getElementById('current-week-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- CORE APP LOGIC ---
        function initialize() {
            setupEventListeners();
            listenForScheduleUpdates();
        }

        function listenForScheduleUpdates() {
            const scheduleCollectionRef = collection(db, `artifacts/${appId}/public/data/schedule`);
            
            // --- OPTIMIZED QUERY: Fetch a relevant date range ---
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1); // 2 months ago
            const endDate = new Date(today.getFullYear(), today.getMonth() + 4, 0);   // 3 months from now
            const startDateString = utils.formatDate(startDate);
            const endDateString = utils.formatDate(endDate);

            const q = query(scheduleCollectionRef, 
                where("date", ">=", startDateString),
                where("date", "<=", endDateString)
            );

            onSnapshot(q, (snapshot) => {
                scheduleData = snapshot.docs.map(doc => doc.data());
                console.log(`Fetched ${scheduleData.length} events from Firestore.`);
                
                processAndGroupData();
                populateFilters();
                renderFullSchedule();
                
                loadingIndicator.classList.add('hidden'); // Hide loader after first render
            }, (error) => {
                console.error("Firestore listener error:", error);
                loadingIndicator.textContent = "Error loading schedule.";
                utils.customAlert("Error connecting to the schedule database.");
            });
        }

        function processAndGroupData() {
            if (scheduleData.length === 0) {
                allWeeks = [];
                return;
            }
            const uniqueDates = [...new Set(scheduleData.map(e => e.date))].sort();
            const weekStarts = [...new Set(uniqueDates.map(d => utils.formatDate(utils.getStartOfWeek(new Date(d + 'T00:00:00Z')))))].sort();
            
            allWeeks = weekStarts.map(startDateStr => {
                const startDate = new Date(startDateStr + 'T00:00:00Z');
                const endDate = new Date(startDate);
                endDate.setUTCDate(endDate.getUTCDate() + 6);
                const days = Array.from({ length: 7 }, (_, i) => {
                    const dayDate = new Date(startDate);
                    dayDate.setUTCDate(startDate.getUTCDate() + i);
                    return dayDate;
                });
                return { startDate, endDate, days };
            });
        }

        // --- UI RENDERING FUNCTIONS ---
        function createEventHTML(event) {
            const batchClass = event.batch.includes('ALL') ? 'bg-gray-500' : 'bg-purple-600';
            const batchText = event.batch.includes('ALL') ? 'All Batches' : 'Batch ' + event.batch.join(', ');
            return `
                <div class="bg-white border-l-4 ${utils.getDeptColor(event.department)} rounded-r-lg p-4 mb-3 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div><p class="font-bold text-lg">${event.topic}</p><p class="text-sm text-gray-600">${event.department}</p></div>
                        <div class="text-right flex-shrink-0 ml-4"><p class="font-semibold text-blue-600">${event.startTime} - ${event.endTime}</p><p class="text-sm text-gray-500">${event.location}</p></div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center text-sm">
                        <p class="text-gray-700"><strong>Instructor:</strong> ${event.instructor}</p>
                        <p class="font-medium text-white text-xs px-2 py-1 rounded-full ${batchClass}">${batchText}</p>
                    </div>
                </div>`;
        }

        function renderFullSchedule() {
            if (intersectionObserver) intersectionObserver.disconnect();
            dayViewContainer.innerHTML = '';
            const selectedDept = deptFilter.value;

            if (allWeeks.length === 0) {
                dayViewContainer.innerHTML = `<div class="p-4 text-center text-gray-500 w-full">No schedule data found for the current period.</div>`;
                weekDisplay.textContent = "No Schedule Available";
                return;
            }

            allWeeks.forEach(week => {
                week.days.forEach(day => {
                    const dayString = utils.formatDate(day);
                    const daySlide = document.createElement('div');
                    daySlide.className = 'day-slide p-4';
                    daySlide.dataset.date = dayString;
                    daySlide.dataset.weekStart = utils.formatDate(week.startDate);
                    if (dayString === utils.formatDate(new Date())) {
                        daySlide.classList.add('today-highlight');
                    }

                    daySlide.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-blue-700">${day.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h2>`;
                    
                    const events = scheduleData.filter(e => e.date === dayString && (selectedDept === 'all' || e.department === selectedDept))
                                             .sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));

                    const classEvents = events.filter(e => !e.isHoliday);
                    if (classEvents.length > 0) {
                        daySlide.innerHTML += classEvents.map(createEventHTML).join('');
                    } else {
                        const isHoliday = events.some(e => e.isHoliday);
                        const isSunday = day.getUTCDay() === 0;
                        daySlide.innerHTML += (isHoliday || isSunday) 
                            ? `<div class="text-center text-green-600 py-20"><p class="text-4xl font-bold">Holiday</p></div>` 
                            : `<div class="text-center text-gray-500 py-10"><p class="font-semibold">No sessions scheduled.</p></div>`;
                    }
                    dayViewContainer.appendChild(daySlide);
                });
            });
            scrollToLatestWeek();
            setupIntersectionObserver();
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            document.getElementById('month-year-display').textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
            calendarGrid.innerHTML = '';

            const month = calendarDate.getUTCMonth();
            const year = calendarDate.getUTCFullYear();
            const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay();
            const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();

            ['S','M','T','W','T','F','S'].forEach(day => { calendarGrid.innerHTML += `<div class="font-bold text-gray-600 ${day === 'S' ? 'sunday' : ''}">${day}</div>`; });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.innerHTML += `<div></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(Date.UTC(year, month, day));
                const dateStr = utils.formatDate(currentDay);
                const dayEvents = scheduleData.filter(e => e.date === dateStr);
                let classes = 'p-2 cursor-pointer hover:bg-gray-200 rounded-full';
                
                if (currentDay.getUTCDay() === 0) classes += ' sunday';
                if (dayEvents.some(e => e.isHoliday)) classes = classes.replace('sunday', '') + ' holiday'; 
                else if (dayEvents.some(e => !e.isHoliday)) classes += ' event-day';
                
                calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
            }
        }

        // --- HELPER & UTILITY FUNCTIONS ---
        function scrollToLatestWeek() {
            if (allWeeks.length > 0) {
                const latestWeek = allWeeks[allWeeks.length - 1];
                const firstDayOfLatestWeek = document.querySelector(`.day-slide[data-date="${utils.formatDate(latestWeek.days[0])}"]`);
                if (firstDayOfLatestWeek) {
                    firstDayOfLatestWeek.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'start' });
                }
            }
        }
        
        function goToToday() {
            const todayStr = utils.formatDate(new Date());
            const todaySlide = document.querySelector(`.day-slide[data-date="${todayStr}"]`);
            if (todaySlide) {
                todaySlide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
            } else {
                utils.customAlert("Today's date is not in the current schedule.");
            }
        }

        function setupIntersectionObserver() {
            const slides = document.querySelectorAll('.day-slide');
            if (slides.length === 0) return;
            intersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const weekStart = entry.target.dataset.weekStart;
                        if (weekStart !== currentVisibleWeekStart) {
                            currentVisibleWeekStart = weekStart;
                            updateHeader(weekStart);
                        }
                    }
                });
            }, { threshold: 0.5, root: dayViewContainer });

            slides.forEach(slide => intersectionObserver.observe(slide));
        }

        function updateHeader(weekStartDateStr) {
            const week = allWeeks.find(w => utils.formatDate(w.startDate) === weekStartDateStr);
            if (week) {
                const start = week.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                const end = week.endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
                weekDisplay.textContent = `${start} - ${end}`;
                calendarDate = new Date(week.startDate);
            }
        }

        function populateFilters() {
            const departments = [...new Set(scheduleData.map(item => item.department).filter(Boolean))].sort();
            const currentVal = deptFilter.value;
            deptFilter.innerHTML = '<option value="all">All Departments</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
            deptFilter.value = currentVal;
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            const calendarModal = document.getElementById('calendar-modal');
            const rollNoModal = document.getElementById('roll-no-modal');
            const rollNoInput = document.getElementById('roll-no-input');

            deptFilter.addEventListener('change', renderFullSchedule);
            document.getElementById('add-to-calendar-btn').addEventListener('click', () => rollNoModal.classList.remove('hidden'));
            document.getElementById('close-roll-no-modal').addEventListener('click', () => rollNoModal.classList.add('hidden'));
            document.getElementById('close-alert-modal').addEventListener('click', () => document.getElementById('alert-modal').classList.add('hidden'));
            document.getElementById('calendar-view-btn').addEventListener('click', () => { renderCalendar(); calendarModal.classList.remove('hidden'); });
            document.getElementById('today-btn').addEventListener('click', goToToday);
            document.getElementById('close-calendar-modal').addEventListener('click', () => calendarModal.classList.add('hidden'));
            document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() - 1); renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() + 1); renderCalendar(); });

            document.getElementById('calendar-grid').addEventListener('click', (e) => {
                if (e.target.dataset.date) {
                    const targetSlide = document.querySelector(`.day-slide[data-date="${e.target.dataset.date}"]`);
                    if (targetSlide) {
                        targetSlide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                    }
                    calendarModal.classList.add('hidden');
                }
            });

            document.getElementById('submit-roll-no-btn').addEventListener('click', () => {
                const rollNo = parseInt(rollNoInput.value);
                if (!rollNo || rollNo < 1 || rollNo > 150) {
                    return utils.customAlert("Please enter a valid Roll Number (1-150).");
                }

                const clinicBatch = utils.getClinicBatch(rollNo);
                const generalBatch = utils.getGeneralBatch(rollNo);
                const currentWeek = allWeeks.find(w => utils.formatDate(w.startDate) === currentVisibleWeekStart);
                if (!currentWeek) {
                    return utils.customAlert("Could not determine the current week.");
                }

                const weekEvents = scheduleData.filter(event => {
                    const eventDate = new Date(event.date + 'T00:00:00Z');
                    return eventDate >= currentWeek.startDate && eventDate <= currentWeek.endDate;
                });

                const eventsToAdd = weekEvents.filter(event => {
                    if (event.isHoliday) return false;
                    if (event.batch.includes('ALL')) return true;
                    if (event.isClinic) return event.batch.includes(clinicBatch);
                    return event.batch.includes(generalBatch);
                });
                
                if (eventsToAdd.length > 0) {
                    const icsData = utils.generateICS(eventsToAdd);
                    utils.downloadICS(icsData, `Schedule-Week-${currentVisibleWeekStart}.ics`);
                } else {
                    utils.customAlert(`No specific schedule found for Roll No. ${rollNo} in the current week.`);
                }
                rollNoModal.classList.add('hidden');
                rollNoInput.value = '';
            });
        }

        // --- INITIALIZE THE APP ---
        initialize();
    </script>
</body>
</html>

