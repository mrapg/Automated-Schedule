<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFMC Weekly Training Schedule</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E293B"/>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AFMC Schedule">
    <link rel="apple-touch-icon" href="icon-180.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* --- Responsive Layout --- */
        /* Mobile-specific styles for swiping */
        @media (max-width: 1023px) {
            .day-view { 
                scroll-snap-type: x mandatory; 
                scroll-behavior: smooth; 
            }
            .day-slide { 
                scroll-snap-align: start; 
                flex-shrink: 0; 
                width: 100%; 
            }
        }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .holiday { background-color: #facc15; color: #713f12; border-radius: 50%; font-weight: bold; }
        .event-day { background-color: #bfdbfe; border-radius: 50%; }
        .sunday { color: #991b1b; }
        .today-highlight { background-color: #dbeafe; }

        /* Festive Holiday Style */
        .holiday-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 2rem 1rem 4rem 1rem;
            text-align: center;
            background: linear-gradient(45deg, #fef3c7, #fde68a);
            border-radius: 0.5rem;
            min-height: 300px;
        }
        .holiday-icon {
            font-size: 4.5rem;
            animation: bounce 2s infinite ease-in-out;
        }
        .holiday-title {
            font-size: 2.75rem;
            font-weight: 800;
            color: #ca8a04;
            margin-top: 1rem;
        }
        .holiday-topic {
            font-size: 1.1rem;
            color: #a16207;
            margin-top: 0.25rem;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-25px); }
            60% { transform: translateY(-10px); }
        }

        /* --- Optimized Night Mode Styles --- */
        .night-mode { background-color: #111827; color: #D1D5DB; }
        .night-mode #app-container { background-color: #1F2937; }
        .night-mode header { background-color: #1E293B; border-bottom: 1px solid #374151; }
        .night-mode #user-view .bg-gray-50 { background-color: #1F2937; border-color: #374151; }
        .night-mode .bg-white { background-color: #374151; }
        .night-mode .text-gray-800 { color: #F3F4F6; }
        .night-mode .text-gray-700 { color: #D1D5DB; }
        .night-mode .text-gray-600 { color: #9CA3AF; }
        .night-mode .text-gray-500 { color: #6B7280; }
        .night-mode .border-gray-200 { border-color: #4B5563; }
        .night-mode .text-blue-700 { color: #22D3EE; }
        .night-mode .text-blue-600 { color: #67E8F9; }
        .night-mode .font-bold { color: #F9FAFB; }
        .night-mode .today-highlight { background-color: #1E293B; }
        .night-mode .event-day { background-color: #0E7490; }
        .night-mode .holiday { background-color: #FBBF24; color: #111827; }
        .night-mode .sunday { color: #F87171; }
        .night-mode select, .night-mode input { background-color: #374151; color: #F3F4F6; border-color: #6B7280;}
        .night-mode #calendar-modal .bg-white,
        .night-mode #roll-no-modal .bg-white,
        .night-mode #alert-modal .bg-white { background-color: #374151; }
        .night-mode .holiday-container { background: linear-gradient(45deg, #374151, #111827); }
        .night-mode .holiday-title { color: #FBBF24; }
        .night-mode .holiday-topic { color: #FDE68A; }
        
        /* Icon Toggle Styles */
        #sun-icon { display: none; }
        .night-mode #sun-icon { display: block; }
        .night-mode #moon-icon { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="max-w-lg lg:max-w-7xl mx-auto bg-white shadow-lg min-h-screen">
        <header class="bg-blue-800 text-white p-4 flex justify-between items-center sticky top-0 z-10">
            <div>
                <h1 class="text-xl font-bold">AFMC Training Schedule</h1>
                <p class="text-xs opacity-80">VI term, 30 Jun - 28 Nov 2025</p>
                <p id="current-week-display" class="text-sm opacity-90 mt-1"></p>
            </div>
            <div class="flex items-center space-x-2">
                 <button id="today-btn" class="p-2 rounded-full hover:bg-blue-700" title="Go to Today">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 002-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /><circle cx="12" cy="12" r="3" fill="currentColor" /></svg>
                </button>
                <button id="calendar-view-btn" class="p-2 rounded-full hover:bg-blue-700" title="Calendar View">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 002-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                </button>
                <button id="night-mode-btn" class="p-2 rounded-full hover:bg-blue-700" title="Toggle Theme">
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                </button>
            </div>
        </header>

        <div id="user-view">
            <div class="p-4 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <select id="department-filter" class="w-full p-2 border rounded-md bg-white lg:col-span-2"><option value="all">All Departments</option></select>
                    <button id="add-to-calendar-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition">Add to Calendar</button>
                </div>
            </div>
            <div id="loading-indicator" class="text-center p-10">
                <p class="text-gray-500 font-semibold animate-pulse">Loading Schedule...</p>
            </div>
            <div id="day-view-container" class="day-view flex lg:grid lg:grid-cols-7 lg:gap-4 lg:p-4"></div>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20"><div class="bg-white rounded-lg shadow-xl p-4 w-11/12 max-w-md"><div id="calendar-header" class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="px-2 py-1">&lt;</button><h3 id="month-year-display" class="text-lg font-semibold"></h3><button id="next-month-btn" class="px-2 py-1">&gt;</button></div><div id="calendar-grid" class="calendar-grid gap-2 text-center"></div><button id="close-calendar-modal" class="w-full mt-4 bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600">Close</button></div></div>
    <div id="roll-no-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-20"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><h3 class="text-lg font-semibold mb-4">Enter Your Roll Number</h3><input type="number" id="roll-no-input" class="w-full p-2 border rounded-md text-center mb-4" placeholder="e.g., 42" min="1" max="150"><button id="submit-roll-no-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded">Get My Schedule File</button><button id="close-roll-no-modal" class="w-full mt-4 bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600">Cancel</button></div></div>
    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30"><div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center"><p id="alert-message" class="mb-4"></p><button id="close-alert-modal" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600">OK</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import * as utils from './utils.js'; 

        const firebaseConfig = {
          apiKey: "AIzaSyC6jkkGL8OA47muh3Bwer9qFRMUejmnso8",
          authDomain: "training-schedule-7c862.firebaseapp.com",
          projectId: "training-schedule-7c862",
          storageBucket: "training-schedule-7c862.firebasestorage.app",
          messagingSenderId: "395637809585",
          appId: "1:395637809585:web:9a5eea7f80741083f49d90",
          measurementId: "G-S9EXHXY981"
        };
        const appId = "training-schedule-7c862";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));

        let scheduleData = [];
        let allWeeks = [];
        let currentVisibleWeekStart = null;
        let calendarDate = new Date();
        let intersectionObserver;

        const dayViewContainer = document.getElementById('day-view-container');
        const deptFilter = document.getElementById('department-filter');
        const weekDisplay = document.getElementById('current-week-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        const termStartDate = new Date('2025-06-30T00:00:00Z');
        const termEndDate = new Date('2025-11-28T00:00:00Z');

        const scheduleRules = {
            "1": { // Monday
                "08:00-09:00": { topic: "Medicine Theory", department: "Internal Medicine", weeks: { from: 1, to: 22 } },
                "09:00-10:00": { topic: "Comm Medicine Theory", department: "Community Medicine", weeks: { from: 1, to: 22 } },
                "14:00-15:00": { topic: "Tutorial Medicine", department: "Internal Medicine", weeks: { from: 1, to: 19 } },
                "15:00-16:00": { topic: "Tutorial FM&T", department: "Forensic Medicine", weeks: { from: 1, to: 19 } },
            },
            "2": { // Tuesday
                "08:00-09:00": { topic: "Surgery", department: "Surgery", weeks: { from: 1, to: 22 } },
                "09:00-10:00": { topic: "PANDEMICS MODULE", department: "Community Medicine", weeks: { from: 1, to: 22 } },
                "14:00-15:00": [
                    { topic: "Tutorial Surgery", department: "Surgery", weeks: { from: 1, to: 13 } },
                    { topic: "Tutorial Dermatology", department: "Dermatology", weeks: { from: 14, to: 19 } },
                ],
                "15:00-16:00": [
                    { topic: "SDL FM&T", department: "Forensic Medicine", weeks: { from: 1, to: 2 } },
                    { topic: "SDL Dermatology", department: "Dermatology", weeks: { from: 3, to: 4 } },
                    { topic: "SDL Orthopaedics", department: "Orthopaedics", weeks: { from: 5, to: 6 } },
                    { topic: "SDL Paediatrics", department: "Pediatrics", weeks: { from: 7, to: 8 } },
                    { topic: "SDL Resp Med", department: "Respiratory Medicine", weeks: { from: 11, to: 12 } },
                ]
            },
            "3": { // Wednesday
                "08:00-09:00": [
                    { topic: "Pediatrics", department: "Pediatrics", weeks: { from: 1, to: 13 } },
                    { topic: "Radiodiagnosis", department: "Radiodiagnosis", weeks: { from: 14, to: 22 } },
                ],
                "09:00-10:00": [
                    { topic: "ENT Theory", department: "ENT", weeks: { from: 1, to: 10 } },
                    { topic: "Tutorial ENT", department: "ENT", weeks: { from: 11, to: 22 } },
                ],
                "14:00-15:00": [
                    { topic: "SDL Comm Med", department: "Community Medicine", weeks: [1, 5, 10] },
                    { topic: "SDL ENT", department: "ENT", weeks: [2, 3, 6, 8] },
                    { topic: "SDL Orthopaedics", department: "Orthopaedics", weeks: [7, 9, 11] },
                    { topic: "SDL Psychiatry", department: "Psychiatry", weeks: [4, 10] },
                    { topic: "SDL Radio diagnosis", department: "Radiodiagnosis", weeks: [12, 13] },
                ]
            },
            "4": { // Thursday
                "08:00-09:00": { topic: "Obst & Gynae", department: "Obs & Gynae", weeks: { from: 1, to: 22 } },
                "09:00-10:00": [
                    { topic: "Dermat", department: "Dermatology", weeks: { from: 1, to: 8 } },
                    { topic: "Anaes", department: "Anaesthesiology", weeks: { from: 9, to: 19 } },
                ],
                "14:00-15:00": { topic: "Tutorial Obst & Gynae", department: "Obs & Gynae", weeks: { from: 1, to: 19 } },
                "15:00-16:00": { topic: "Tutorial Community Medicine", department: "Community Medicine", weeks: { from: 1, to: 19 } },
            },
            "5": { // Friday
                "08:00-09:00": { topic: "FM&T", department: "Forensic Medicine", weeks: { from: 1, to: 22 } },
                "09:00-10:00": [
                    { topic: "FM&T", department: "Forensic Medicine", weeks: { from: 1, to: 5 } },
                    { topic: "Community Medicine", department: "Community Medicine", weeks: { from: 6, to: 10 } },
                    { topic: "Ophthalmology", department: "Ophthalmology", weeks: { from: 11, to: 15 } },
                    { topic: "ENT", department: "ENT", weeks: { from: 16, to: 20 } },
                ],
                "14:00-15:00": [
                    { topic: "Tutorial Paediatrics", department: "Pediatrics", weeks: { from: 1, to: 14 } },
                    { topic: "Tutorial Anaesthesiology", department: "Anaesthesiology", weeks: { from: 15, to: 19 } },
                ],
                "15:00-16:00": [
                    { topic: "Tutorial Psy", department: "Psychiatry", weeks: { from: 1, to: 10 } },
                    { topic: "Tutorial Anaesthesiology", department: "Anaesthesiology", weeks: { from: 11, to: 14 } },
                    { topic: "Tutorial Resp Med", department: "Respiratory Medicine", weeks: { from: 15, to: 17 } },
                ]
            },
            "6": { // Saturday
                "08:00-09:00": { topic: "Orthopaedics", department: "Orthopaedics", weeks: { from: 1, to: 19 } },
                "09:00-10:00": { topic: "Ophthalmology", department: "Ophthalmology", weeks: { from: 1, to: 19 } },
                "14:00-15:00": { topic: "Tutorial Community Medicine", department: "Community Medicine", weeks: { from: 1, to: 19 } }
            }
        };

        function generateGenericSchedule() {
            const genericSchedule = [];
            const getTermWeek = (currentDate) => {
                const diff = currentDate.getTime() - termStartDate.getTime();
                return Math.floor(diff / (1000 * 60 * 60 * 24 * 7)) + 1;
            };

            let currentDate = new Date(termStartDate);
            while (currentDate <= termEndDate) {
                const dayOfWeek = currentDate.getUTCDay();
                if (dayOfWeek === 0) {
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                    continue;
                }
                const termWeek = getTermWeek(currentDate);
                const dayRules = scheduleRules[dayOfWeek];
                if (dayRules) {
                    for (const timeSlot in dayRules) {
                        let events = dayRules[timeSlot];
                        if (!Array.isArray(events)) events = [events];
                        events.forEach(rule => {
                            const { topic, department, weeks } = rule;
                            let isInWeek = false;
                            if (Array.isArray(weeks)) {
                                if (weeks.includes(termWeek)) isInWeek = true;
                            } else if (weeks && weeks.from && weeks.to) {
                                if (termWeek >= weeks.from && termWeek <= weeks.to) isInWeek = true;
                            }
                            if (isInWeek) {
                                const [startTime, endTime] = timeSlot.split('-');
                                genericSchedule.push({
                                    date: utils.formatDate(currentDate), startTime, endTime, topic, department,
                                    instructor: "TBD", location: "TBD", batch: ["ALL"],
                                    isHoliday: false, isClinic: false, isGeneric: true 
                                });
                            }
                        });
                    }
                }
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }
            return genericSchedule;
        }

        /**
         * Standardizes department names to a consistent format.
         * @param {string} dept The original department name.
         * @returns {string} The standardized department name.
         */
        function standardizeDepartmentName(dept) {
            if (!dept) return dept;
            const d = dept.toLowerCase().trim();

            const aliases = {
                'psm': 'Community Medicine',
                'comm medicine': 'Community Medicine',
                'medicine': 'Internal Medicine',
                'obstetrics & gynaecology': 'Obs & Gynae',
                'gynae': 'Obs & Gynae',
                'fm&t': 'Forensic Medicine',
                'forensic medicine & toxicology': 'Forensic Medicine',
                'dermat': 'Dermatology',
                'paediatrics': 'Pediatrics',
                'ortho': 'Orthopaedics',
                'resp med': 'Respiratory Medicine',
                'radio diagnosis': 'Radiodiagnosis',
                'radiodiagnosis': 'Radiodiagnosis',
                'psy': 'Psychiatry',
                'anaes': 'Anaesthesiology'
            };
            
            if (aliases[d]) return aliases[d];

            if (d.includes('comm med')) return 'Community Medicine';
            if (d.includes('fm&t')) return 'Forensic Medicine';
            if (d.includes('paediatrics')) return 'Pediatrics';
            if (d.includes('resp med')) return 'Respiratory Medicine';
            if (d.includes('radio diagnosis')) return 'Radiodiagnosis';
            if (d.includes('psy')) return 'Psychiatry';

            return dept;
        }
        
        function mergeSchedules(genericSchedule, specificSchedule) {
            genericSchedule.forEach(e => e.department = standardizeDepartmentName(e.department));
            specificSchedule.forEach(e => e.department = standardizeDepartmentName(e.department));

            const finalScheduleMap = new Map();
            const specificEventsByWeek = new Map();
            const holidayDates = new Set(specificSchedule.filter(e => e.isHoliday).map(e => e.date));

            specificSchedule.forEach(event => {
                if (event.isHoliday) return;
                const weekStart = utils.formatDate(utils.getStartOfWeek(new Date(event.date + 'T00:00:00Z')));
                if (!specificEventsByWeek.has(weekStart)) {
                    specificEventsByWeek.set(weekStart, new Set());
                }
                specificEventsByWeek.get(weekStart).add(event.department);
            });

            genericSchedule.forEach(event => {
                if (holidayDates.has(event.date)) return;

                const weekStart = utils.formatDate(utils.getStartOfWeek(new Date(event.date + 'T00:00:00Z')));
                const deptsWithSpecificEvents = specificEventsByWeek.get(weekStart);

                if (!deptsWithSpecificEvents || !deptsWithSpecificEvents.has(event.department)) {
                    const key = `${event.date}|${event.startTime}|${event.endTime}|${JSON.stringify((event.batch || []).sort())}`;
                    finalScheduleMap.set(key, event);
                }
            });

            specificSchedule.forEach(event => {
                if (event.isHoliday) return;
                const key = `${event.date}|${event.startTime}|${event.endTime}|${JSON.stringify((event.batch || []).sort())}`;
                finalScheduleMap.set(key, event);
            });

            specificSchedule.forEach(event => {
                if (event.isHoliday) {
                    const key = `${event.date}|holiday|${event.topic}`;
                    finalScheduleMap.set(key, event);
                }
            });

            return Array.from(finalScheduleMap.values());
        }

        function initialize() {
            applyInitialTheme();
            setupEventListeners();
            listenForScheduleUpdates();
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'night') {
                document.body.classList.add('night-mode');
            }
        }

        function listenForScheduleUpdates() {
            const scheduleCollectionRef = collection(db, `artifacts/${appId}/public/data/schedule`);
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 4, 0);
            const q = query(scheduleCollectionRef, where("date", ">=", utils.formatDate(startDate)), where("date", "<=", utils.formatDate(endDate)));

            onSnapshot(q, (snapshot) => {
                const uniqueEventsMap = new Map();
                snapshot.docs.forEach(doc => {
                    const event = doc.data();
                    const batchKey = Array.isArray(event.batch) ? JSON.stringify(event.batch.sort()) : event.batch;
                    const key = `${event.date}|${event.startTime}|${event.topic}|${event.instructor}|${batchKey}`;
                    
                    if (!uniqueEventsMap.has(key)) {
                        uniqueEventsMap.set(key, event);
                    }
                });
                const specificSchedule = Array.from(uniqueEventsMap.values());
                const genericSchedule = generateGenericSchedule();
                scheduleData = mergeSchedules(genericSchedule, specificSchedule);
                
                processAndGroupData();
                populateFilters();
                renderFullSchedule();
                
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Firestore listener error:", error);
                loadingIndicator.textContent = "Error loading schedule.";
                utils.customAlert("Error connecting to the schedule database.");
            });
        }

        function processAndGroupData() {
            if (scheduleData.length === 0) {
                allWeeks = [];
                return;
            }
            const uniqueDates = [...new Set(scheduleData.map(e => e.date))].sort();
            const weekStarts = [...new Set(uniqueDates.map(d => utils.formatDate(utils.getStartOfWeek(new Date(d + 'T00:00:00Z')))))].sort();
            
            allWeeks = weekStarts.map(startDateStr => {
                const startDate = new Date(startDateStr + 'T00:00:00Z');
                const endDate = new Date(startDate);
                endDate.setUTCDate(endDate.getUTCDate() + 6);
                const days = Array.from({ length: 7 }, (_, i) => {
                    const dayDate = new Date(startDate);
                    dayDate.setUTCDate(startDate.getUTCDate() + i);
                    return dayDate;
                });
                return { startDate, endDate, days };
            });
        }

        function createEventHTML(event) {
            const batchClass = event.batch && event.batch.includes('ALL') ? 'bg-gray-500' : 'bg-purple-600';
            const batchText = event.batch ? (event.batch.includes('ALL') ? 'All Batches' : 'Batch ' + event.batch.join(', ')) : 'N/A';
            const genericIndicator = event.isGeneric ? '<span class="text-xs font-semibold text-gray-500 ml-2">(Term Schedule)</span>' : '';
            return `
                <div class="bg-white border-l-4 ${utils.getDeptColor(event.department)} rounded-r-lg p-4 mb-3 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div><p class="font-bold text-lg">${event.topic}${genericIndicator}</p><p class="text-sm text-gray-600">${event.department}</p></div>
                        <div class="text-right flex-shrink-0 ml-4"><p class="font-semibold text-blue-600">${event.startTime} - ${event.endTime}</p><p class="text-sm text-gray-500">${event.location}</p></div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center text-sm">
                        <p class="text-gray-700"><strong>Instructor:</strong> ${event.instructor}</p>
                        <p class="min-w-[6rem] text-center whitespace-nowrap font-medium text-white text-xs px-2 py-1 rounded-full ${batchClass}">${batchText}</p>
                    </div>
                </div>`;
        }
        
        function renderFullSchedule() {
            if (intersectionObserver) intersectionObserver.disconnect();
            dayViewContainer.innerHTML = '';
            const selectedDept = deptFilter.value;

            if (allWeeks.length === 0) {
                dayViewContainer.innerHTML = `<div class="p-4 text-center text-gray-500 w-full">No schedule data found for the current period.</div>`;
                weekDisplay.textContent = "No Schedule Available";
                return;
            }

            allWeeks.forEach(week => {
                week.days.forEach(day => {
                    const dayString = utils.formatDate(day);
                    const daySlide = document.createElement('div');
                    daySlide.className = 'day-slide p-4 lg:p-2 lg:flex lg:flex-col lg:border lg:border-gray-200 lg:rounded-lg';
                    if (document.body.classList.contains('night-mode')) {
                        daySlide.classList.add('lg:border-gray-700');
                    }
                    daySlide.dataset.date = dayString;
                    daySlide.dataset.weekStart = utils.formatDate(week.startDate);
                    if (dayString === utils.formatDate(new Date())) {
                        daySlide.classList.add('today-highlight');
                    }
                    
                    let dayHtml = `<h2 class="text-lg font-bold mb-2 text-blue-700">${day.toLocaleDateString('en-US', { weekday: 'long', day: 'numeric', month: 'short', timeZone: 'UTC' })}</h2>`;
                    
                    const dayEvents = scheduleData.filter(e => e.date === dayString);
                    const isHoliday = dayEvents.some(e => e.isHoliday);

                    if (isHoliday) {
                        const holidayEvent = dayEvents.find(e => e.isHoliday);
                        const holidayTopic = (holidayEvent && holidayEvent.topic && holidayEvent.topic.toLowerCase() !== 'holiday') ? holidayEvent.topic : '';
                        dayHtml += `
                            <div class="holiday-container flex-grow">
                                <div class="holiday-icon">🎉</div>
                                <p class="holiday-title">Holiday</p>
                                <p class="holiday-topic">${holidayTopic}</p>
                            </div>`;
                    } else {
                        const classEvents = dayEvents.filter(e => selectedDept === 'all' || e.department === selectedDept)
                                                     .sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));

                        if (classEvents.length > 0) {
                            dayHtml += classEvents.map(createEventHTML).join('');
                        } else if (day.getUTCDay() === 0) {
                             dayHtml += `
                                <div class="holiday-container flex-grow">
                                    <div class="holiday-icon">🎉</div>
                                    <p class="holiday-title">Holiday</p>
                                </div>`;
                        } else {
                            dayHtml += `<div class="text-center text-gray-500 py-10"><p class="font-semibold">No sessions scheduled.</p></div>`;
                        }
                    }
                    daySlide.innerHTML = dayHtml;
                    dayViewContainer.appendChild(daySlide);
                });
            });
            goToToday(false);
            setupIntersectionObserver();
        }
        
        function populateFilters() {
            const departments = [...new Set(scheduleData
                .map(item => item.department)
                .filter(dept => dept && !['Holiday', 'Multi-Dept', 'AETCOM'].includes(dept))
            )].sort();
            
            const currentVal = deptFilter.value;
            deptFilter.innerHTML = '<option value="all">All Departments</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
            deptFilter.value = currentVal;
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            document.getElementById('month-year-display').textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
            calendarGrid.innerHTML = '';
            const month = calendarDate.getUTCMonth();
            const year = calendarDate.getUTCFullYear();
            const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay();
            const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
            ['S','M','T','W','T','F','S'].forEach(day => { calendarGrid.innerHTML += `<div class="font-bold text-gray-600 ${day === 'S' ? 'sunday' : ''}">${day}</div>`; });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.innerHTML += `<div></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(Date.UTC(year, month, day));
                const dateStr = utils.formatDate(currentDay);
                const dayEvents = scheduleData.filter(e => e.date === dateStr);
                let classes = 'p-2 cursor-pointer hover:bg-gray-200 rounded-full';
                
                const isSunday = currentDay.getUTCDay() === 0;
                const isDataHoliday = dayEvents.some(e => e.isHoliday);
                const hasClassEvents = dayEvents.some(e => !e.isHoliday);
                if (isDataHoliday || (isSunday && !hasClassEvents)) {
                    classes += ' holiday';
                } else if (hasClassEvents) {
                    classes += ' event-day';
                }
                
                if (isSunday) {
                    classes += ' sunday';
                }
                
                calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
            }
        }

        function scrollToLatestWeek() {
            if (allWeeks.length > 0) {
                const latestWeek = allWeeks[allWeeks.length - 1];
                const firstDayOfLatestWeek = document.querySelector(`.day-slide[data-date="${utils.formatDate(latestWeek.days[0])}"]`);
                if (firstDayOfLatestWeek) {
                    firstDayOfLatestWeek.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'start' });
                }
            }
        }
        
        function goToToday(smooth = true) {
            const todayStr = utils.formatDate(new Date());
            const todaySlide = document.querySelector(`.day-slide[data-date="${todayStr}"]`);
            if (todaySlide) {
                todaySlide.scrollIntoView({ behavior: smooth ? 'smooth' : 'auto', block: 'nearest', inline: 'start' });
                 setTimeout(() => { window.scrollTo({ top: 0, behavior: 'auto' }); }, 0);
            } else if (!smooth) {
                scrollToLatestWeek();
            } else {
                utils.customAlert("Today's date is not in the current schedule.");
            }
        }

        function setupIntersectionObserver() {
            const slides = document.querySelectorAll('.day-slide');
            if (slides.length === 0) return;
            intersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const weekStart = entry.target.dataset.weekStart;
                        if (weekStart !== currentVisibleWeekStart) {
                            currentVisibleWeekStart = weekStart;
                            updateHeader(weekStart);
                        }
                    }
                });
            }, { threshold: 0.5, root: dayViewContainer });

            slides.forEach(slide => intersectionObserver.observe(slide));
        }

        function updateHeader(weekStartDateStr) {
            const week = allWeeks.find(w => utils.formatDate(w.startDate) === weekStartDateStr);
            if (week) {
                const start = week.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                const end = week.endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
                weekDisplay.textContent = `${start} - ${end}`;
                calendarDate = new Date(week.startDate);
            }
        }

        function setupEventListeners() {
            const calendarModal = document.getElementById('calendar-modal');
            const rollNoModal = document.getElementById('roll-no-modal');
            const rollNoInput = document.getElementById('roll-no-input');
            const nightModeBtn = document.getElementById('night-mode-btn');

            deptFilter.addEventListener('change', renderFullSchedule);
            document.getElementById('add-to-calendar-btn').addEventListener('click', () => rollNoModal.classList.remove('hidden'));
            document.getElementById('close-roll-no-modal').addEventListener('click', () => rollNoModal.classList.add('hidden'));
            document.getElementById('close-alert-modal').addEventListener('click', () => document.getElementById('alert-modal').classList.add('hidden'));
            document.getElementById('calendar-view-btn').addEventListener('click', () => { renderCalendar(); calendarModal.classList.remove('hidden'); });
            document.getElementById('today-btn').addEventListener('click', () => goToToday(true));
            document.getElementById('close-calendar-modal').addEventListener('click', () => calendarModal.classList.add('hidden'));
            document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() - 1); renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() + 1); renderCalendar(); });

            nightModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
                if (document.body.classList.contains('night-mode')) {
                    localStorage.setItem('theme', 'night');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });

            document.getElementById('calendar-grid').addEventListener('click', (e) => {
                if (e.target.dataset.date) {
                    const targetSlide = document.querySelector(`.day-slide[data-date="${e.target.dataset.date}"]`);
                    if (targetSlide) {
                        targetSlide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                        setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 300);
                    }
                    calendarModal.classList.add('hidden');
                }
            });

            document.getElementById('submit-roll-no-btn').addEventListener('click', () => {
                const rollNo = parseInt(rollNoInput.value);
                if (!rollNo || rollNo < 1 || rollNo > 150) {
                    return utils.customAlert("Please enter a valid Roll Number (1-150).");
                }

                const clinicBatch = utils.getClinicBatch(rollNo);
                const generalBatch = utils.getGeneralBatch(rollNo);
                const currentWeek = allWeeks.find(w => utils.formatDate(w.startDate) === currentVisibleWeekStart);
                if (!currentWeek) {
                    return utils.customAlert("Could not determine the current week.");
                }

                const weekEvents = scheduleData.filter(event => {
                    const eventDate = new Date(event.date + 'T00:00:00Z');
                    return eventDate >= currentWeek.startDate && eventDate <= currentWeek.endDate;
                });

                const eventsToAdd = weekEvents.filter(event => {
                    if (event.isHoliday) return false;
                    if (event.batch.includes('ALL')) return true;
                    if (event.isClinic) return event.batch.includes(clinicBatch);
                    return event.batch.includes(generalBatch);
                });
                
                if (eventsToAdd.length > 0) {
                    const icsData = utils.generateICS(eventsToAdd);
                    utils.downloadICS(icsData, `Schedule-Week-${currentVisibleWeekStart}.ics`);
                } else {
                    utils.customAlert(`No specific schedule found for Roll No. ${rollNo} in the current week.`);
                }
                rollNoModal.classList.add('hidden');
                rollNoInput.value = '';
            });
        }

        initialize();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
