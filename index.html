<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Import everything from our new central utility file
        import * as utils from './utils.js'; 

        const firebaseConfig = {
          apiKey: "AIzaSyC6jkkGL8OA47muh3Bwer9qFRMUejmnso8",
          authDomain: "training-schedule-7c862.firebaseapp.com",
          projectId: "training-schedule-7c862",
          storageBucket: "training-schedule-7c862.firebasestorage.app",
          messagingSenderId: "395637809585",
          appId: "1:395637809585:web:9a5eea7f80741083f49d90",
          measurementId: "G-S9EXHXY981"
        };
        const appId = "training-schedule-7c862";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        signInAnonymously(auth).catch((error) => console.error("Anonymous sign-in failed:", error));

        let scheduleData = [];
        let allWeeks = [];
        let currentVisibleWeekStart = null;
        let calendarDate = new Date();
        let intersectionObserver;

        const dayViewContainer = document.getElementById('day-view-container');
        const deptFilter = document.getElementById('department-filter');
        const weekDisplay = document.getElementById('current-week-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Note: scheduleRules, generateGenericSchedule, standardizeDepartmentName, and mergeSchedules
        // have been REMOVED from this file and are now imported from utils.js

        function initialize() {
            applyInitialTheme();
            setupEventListeners();
            listenForScheduleUpdates();
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'night') {
                document.body.classList.add('night-mode');
            }
        }

        function listenForScheduleUpdates() {
            const scheduleCollectionRef = collection(db, `artifacts/${appId}/public/data/schedule`);
            const today = new Date();
            const startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            const endDate = new Date(today.getFullYear(), today.getMonth() + 4, 0);
            const q = query(scheduleCollectionRef, where("date", ">=", utils.formatDate(startDate)), where("date", "<=", utils.formatDate(endDate)));

            onSnapshot(q, (snapshot) => {
                const uniqueEventsMap = new Map();
                snapshot.docs.forEach(doc => {
                    const event = doc.data();
                    const batchKey = Array.isArray(event.batch) ? JSON.stringify(event.batch.sort()) : event.batch;
                    const key = `${event.date}|${event.startTime}|${event.topic}|${event.instructor}|${batchKey}`;
                    
                    if (!uniqueEventsMap.has(key)) {
                        uniqueEventsMap.set(key, event);
                    }
                });
                const specificSchedule = Array.from(uniqueEventsMap.values());
                
                // Use the new utility functions to build the schedule
                const genericSchedule = utils.generateGenericSchedule();
                scheduleData = utils.mergeSchedules(genericSchedule, specificSchedule);
                
                processAndGroupData();
                populateFilters();
                renderFullSchedule();
                
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Firestore listener error:", error);
                loadingIndicator.textContent = "Error loading schedule.";
                utils.customAlert("Error connecting to the schedule database.");
            });
        }

        function processAndGroupData() {
            if (scheduleData.length === 0) {
                allWeeks = [];
                return;
            }
            const uniqueDates = [...new Set(scheduleData.map(e => e.date))].sort();
            const weekStarts = [...new Set(uniqueDates.map(d => utils.formatDate(utils.getStartOfWeek(new Date(d + 'T00:00:00Z')))))].sort();
            
            allWeeks = weekStarts.map(startDateStr => {
                const startDate = new Date(startDateStr + 'T00:00:00Z');
                const endDate = new Date(startDate);
                endDate.setUTCDate(endDate.getUTCDate() + 6);
                const days = Array.from({ length: 7 }, (_, i) => {
                    const dayDate = new Date(startDate);
                    dayDate.setUTCDate(startDate.getUTCDate() + i);
                    return dayDate;
                });
                return { startDate, endDate, days };
            });
        }

        function createEventHTML(event) {
            const batchClass = event.batch && event.batch.includes('ALL') ? 'bg-gray-500' : 'bg-purple-600';
            const batchText = event.batch ? (event.batch.includes('ALL') ? 'All Batches' : 'Batch ' + event.batch.join(', ')) : 'N/A';
            const genericIndicator = event.isGeneric && !event.instructor.toLowerCase().includes('tbd') ? '' : (event.isGeneric ? '<span class="text-xs font-semibold text-gray-500 ml-2">(Term Schedule)</span>' : '');
            return `
                <div class="bg-white border-l-4 ${utils.getDeptColor(event.department)} rounded-r-lg p-4 mb-3 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start">
                        <div><p class="font-bold text-lg">${event.topic}${genericIndicator}</p><p class="text-sm text-gray-600">${event.department}</p></div>
                        <div class="text-right flex-shrink-0 ml-4"><p class="font-semibold text-blue-600">${event.startTime} - ${event.endTime}</p><p class="text-sm text-gray-500">${event.location}</p></div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-between items-center text-sm">
                        <p class="text-gray-700"><strong>Instructor:</strong> ${event.instructor}</p>
                        <p class="min-w-[6rem] text-center whitespace-nowrap font-medium text-white text-xs px-2 py-1 rounded-full ${batchClass}">${batchText}</p>
                    </div>
                </div>`;
        }
        
        function renderFullSchedule() {
            if (intersectionObserver) intersectionObserver.disconnect();
            dayViewContainer.innerHTML = '';
            const selectedDept = deptFilter.value;

            if (allWeeks.length === 0) {
                dayViewContainer.innerHTML = `<div class="p-4 text-center text-gray-500 w-full">No schedule data found for the current period.</div>`;
                weekDisplay.textContent = "No Schedule Available";
                return;
            }

            allWeeks.forEach(week => {
                week.days.forEach(day => {
                    const dayString = utils.formatDate(day);
                    const daySlide = document.createElement('div');
                    daySlide.className = 'day-slide p-4';
                    daySlide.dataset.date = dayString;
                    daySlide.dataset.weekStart = utils.formatDate(week.startDate);
                    if (dayString === utils.formatDate(new Date())) {
                        daySlide.classList.add('today-highlight');
                    }
                    daySlide.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-blue-700">${day.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', timeZone: 'UTC' })}</h2>`;
                    
                    const dayEvents = scheduleData.filter(e => e.date === dayString);
                    const isHoliday = dayEvents.some(e => e.isHoliday);

                    if (isHoliday) {
                        const holidayEvent = dayEvents.find(e => e.isHoliday);
                        const holidayTopic = (holidayEvent && holidayEvent.topic && holidayEvent.topic.toLowerCase() !== 'holiday') ? holidayEvent.topic : '';
                        daySlide.innerHTML += `
                            <div class="holiday-container">
                                <div class="holiday-icon">ðŸŽ‰</div>
                                <p class="holiday-title">Holiday</p>
                                <p class="holiday-topic">${holidayTopic}</p>
                            </div>`;
                    } else {
                        const classEvents = dayEvents.filter(e => selectedDept === 'all' || e.department === selectedDept)
                                                     .sort((a, b) => (a.startTime || "00:00").localeCompare(b.startTime || "00:00"));

                        if (classEvents.length > 0) {
                            daySlide.innerHTML += classEvents.map(createEventHTML).join('');
                        } else if (day.getUTCDay() === 0) { // It's a Sunday with no other events
                             daySlide.innerHTML += `
                                <div class="holiday-container">
                                    <div class="holiday-icon">ðŸŽ‰</div>
                                    <p class="holiday-title">Holiday</p>
                                </div>`;
                        } else { // It's a weekday with no events
                            daySlide.innerHTML += `<div class="text-center text-gray-500 py-10"><p class="font-semibold">No sessions scheduled.</p></div>`;
                        }
                    }
                    dayViewContainer.appendChild(daySlide);
                });
            });
            goToToday(false);
            setupIntersectionObserver();
        }
        
        function populateFilters() {
            const departments = [...new Set(scheduleData
                .map(item => item.department)
                .filter(dept => dept && !['Holiday', 'Multi-Dept', 'AETCOM'].includes(dept))
            )].sort();
            
            const currentVal = deptFilter.value;
            deptFilter.innerHTML = '<option value="all">All Departments</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptFilter.appendChild(option);
            });
            deptFilter.value = currentVal;
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            document.getElementById('month-year-display').textContent = calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
            calendarGrid.innerHTML = '';
            const month = calendarDate.getUTCMonth();
            const year = calendarDate.getUTCFullYear();
            const firstDayOfMonth = new Date(Date.UTC(year, month, 1)).getUTCDay();
            const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
            ['S','M','T','W','T','F','S'].forEach(day => { calendarGrid.innerHTML += `<div class="font-bold text-gray-600 ${day === 'S' ? 'sunday' : ''}">${day}</div>`; });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.innerHTML += `<div></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDay = new Date(Date.UTC(year, month, day));
                const dateStr = utils.formatDate(currentDay);
                const dayEvents = scheduleData.filter(e => e.date === dateStr);
                let classes = 'p-2 cursor-pointer hover:bg-gray-200 rounded-full';
                
                const isSunday = currentDay.getUTCDay() === 0;
                const isDataHoliday = dayEvents.some(e => e.isHoliday);
                const hasClassEvents = dayEvents.some(e => !e.isHoliday);
                if (isDataHoliday || (isSunday && !hasClassEvents)) {
                    classes += ' holiday';
                } else if (hasClassEvents) {
                    classes += ' event-day';
                }
                
                if (isSunday) {
                    classes += ' sunday';
                }
                
                calendarGrid.innerHTML += `<div class="${classes}" data-date="${dateStr}">${day}</div>`;
            }
        }

        function scrollToLatestWeek() {
            if (allWeeks.length > 0) {
                const latestWeek = allWeeks[allWeeks.length - 1];
                const firstDayOfLatestWeek = document.querySelector(`.day-slide[data-date="${utils.formatDate(latestWeek.days[0])}"]`);
                if (firstDayOfLatestWeek) {
                    firstDayOfLatestWeek.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'start' });
                }
            }
        }
        
        function goToToday(smooth = true) {
            const todayStr = utils.formatDate(new Date());
            const todaySlide = document.querySelector(`.day-slide[data-date="${todayStr}"]`);
            if (todaySlide) {
                todaySlide.scrollIntoView({ behavior: smooth ? 'smooth' : 'auto', block: 'nearest', inline: 'start' });
                 setTimeout(() => { window.scrollTo({ top: 0, behavior: 'auto' }); }, 0);
            } else if (!smooth) {
                scrollToLatestWeek();
            } else {
                utils.customAlert("Today's date is not in the current schedule.");
            }
        }

        function setupIntersectionObserver() {
            const slides = document.querySelectorAll('.day-slide');
            if (slides.length === 0) return;
            intersectionObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const weekStart = entry.target.dataset.weekStart;
                        if (weekStart !== currentVisibleWeekStart) {
                            currentVisibleWeekStart = weekStart;
                            updateHeader(weekStart);
                        }
                    }
                });
            }, { threshold: 0.5, root: dayViewContainer });

            slides.forEach(slide => intersectionObserver.observe(slide));
        }

        function updateHeader(weekStartDateStr) {
            const week = allWeeks.find(w => utils.formatDate(w.startDate) === weekStartDateStr);
            if (week) {
                const start = week.startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                const end = week.endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
                weekDisplay.textContent = `${start} - ${end}`;
                calendarDate = new Date(week.startDate);
            }
        }

        function setupEventListeners() {
            const calendarModal = document.getElementById('calendar-modal');
            const rollNoModal = document.getElementById('roll-no-modal');
            const rollNoInput = document.getElementById('roll-no-input');
            const nightModeBtn = document.getElementById('night-mode-btn');

            deptFilter.addEventListener('change', renderFullSchedule);
            document.getElementById('add-to-calendar-btn').addEventListener('click', () => rollNoModal.classList.remove('hidden'));
            document.getElementById('close-roll-no-modal').addEventListener('click', () => rollNoModal.classList.add('hidden'));
            document.getElementById('close-alert-modal').addEventListener('click', () => document.getElementById('alert-modal').classList.add('hidden'));
            document.getElementById('calendar-view-btn').addEventListener('click', () => { renderCalendar(); calendarModal.classList.remove('hidden'); });
            document.getElementById('today-btn').addEventListener('click', () => goToToday(true));
            document.getElementById('close-calendar-modal').addEventListener('click', () => calendarModal.classList.add('hidden'));
            document.getElementById('prev-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() - 1); renderCalendar(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { calendarDate.setUTCMonth(calendarDate.getUTCMonth() + 1); renderCalendar(); });

            nightModeBtn.addEventListener('click', () => {
                document.body.classList.toggle('night-mode');
                if (document.body.classList.contains('night-mode')) {
                    localStorage.setItem('theme', 'night');
                } else {
                    localStorage.setItem('theme', 'light');
                }
            });

            document.getElementById('calendar-grid').addEventListener('click', (e) => {
                if (e.target.dataset.date) {
                    const targetSlide = document.querySelector(`.day-slide[data-date="${e.target.dataset.date}"]`);
                    if (targetSlide) {
                        targetSlide.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                        setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 300);
                    }
                    calendarModal.classList.add('hidden');
                }
            });

            document.getElementById('submit-roll-no-btn').addEventListener('click', () => {
                const rollNo = parseInt(rollNoInput.value);
                if (!rollNo || rollNo < 1 || rollNo > 150) {
                    return utils.customAlert("Please enter a valid Roll Number (1-150).");
                }

                const clinicBatch = utils.getClinicBatch(rollNo);
                const generalBatch = utils.getGeneralBatch(rollNo);
                const currentWeek = allWeeks.find(w => utils.formatDate(w.startDate) === currentVisibleWeekStart);
                if (!currentWeek) {
                    return utils.customAlert("Could not determine the current week.");
                }

                const weekEvents = scheduleData.filter(event => {
                    const eventDate = new Date(event.date + 'T00:00:00Z');
                    return eventDate >= currentWeek.startDate && eventDate <= currentWeek.endDate;
                });

                const eventsToAdd = weekEvents.filter(event => {
                    if (event.isHoliday) return false;
                    if (event.batch.includes('ALL')) return true;
                    if (event.isClinic) return event.batch.includes(clinicBatch);
                    return event.batch.includes(generalBatch);
                });
                
                if (eventsToAdd.length > 0) {
                    const icsData = utils.generateICS(eventsToAdd);
                    utils.downloadICS(icsData, `Schedule-Week-${currentVisibleWeekStart}.ics`);
                } else {
                    utils.customAlert(`No specific schedule found for Roll No. ${rollNo} in the current week.`);
                }
                rollNoModal.classList.add('hidden');
                rollNoInput.value = '';
            });
        }

        initialize();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
